# 概要
Qiita APIを使用してQiita Teamから記事を画像つきでエクスポートするスクリプトです。

# エクスポート内容
エクスポートファイルはallarticle2mdsets.rbを実行下ディレクトリの直下に以下の構成で作成されます。

* 取得した記事一覧のCSVファイル
* Qiita Teamのグループ名をディレクトリ名としたディレクトリ
  * {通し番号}_{記事のタイトル}をディレクトリ名としたディレクトリ
    * 記事のmdファイル {記事名}.md
    * 記事のmeta情報 {記事名}_meta.json
    * 記事に含まれていた画像ファイル

※グループ名、記事名に半角スラッシュが含まれていた場合、 全角スラッシュに変換されます。

## エクスポート内容詳細
### 通し番号について
通し番号は記事の作成日時の降順に、このスクリプト内で1から順に付与しています。

### 取得した記事一覧のCSVファイル
取得した記事それぞれについて以下の情報が出力されます。
* \#: 通し番号
* Group: Qiita Team内のグループ名
* Title: 記事のタイトル
* Tags: 記事のタグ (複数ある場合は半角スラッシュで区切られます。)
* Qiita URL: Qiita Team上のURL

また、CSVファイルのファイル名は本スクリプト実行時の起動引数をもとに作成されます。

### 記事のmdファイル
記事のmd形式のファイルです。

### 記事のmeta情報
記事の投稿者、更新日時、HTML形式の本文などの情報が入っています。  
※ https://qiita.com/api/v2/docs#get-apiv2items のレスポンス内容をそのままjson形式にしたものです。

### 記事に含まれていた画像ファイル
記事に含まれていた画像ファイルをダウンロードしたものです。  
画像ごとに1ファイル生成されます。

# 動作環境
rubyのバージョンは2.x系  
qiitaのクライアントをインストールする必要あり  
> gem install qiita

# 前提条件
Qiita Teamから予め個人用アクセストークンを発行しておく

# 使用方法
1. allarticle2mdsets.rbを任意のディレクトリに配置する。
2. 同一階層に記事の出力先とするディレクトリを作成
3. そのディレクトリへ移動する(このスクリプトは実行ディレクトリ配下にファイルを出力する)
4. Qiita Teamの個人用アクセストークンを環境変数にエクスポートする
   * 例) export QIITA_ACCESS_TOKEN='Qiitaから払い出したトークンID'
5. allarticle2mdsets.rbを実行する

例) hogehoge というグループから検索条件無しで100件ずつ10回データの取得をする場合
../allarticle2mdsets.rb hogehoge "" 100 10

例) 上記の例で11ページ目からデータの取得を行う場合  
../allarticle2mdsets.rb hogehoge "" 100 10 11

※スクリプト実行時、ダウンロードした記事名が標準出力に出力されます。

## allarticle2mdsets.rb実行時の引数
第１引数:Qiita teamの固有ドメイン部分を指定してください。(.qiita.comの部分は不要)

第２引数は検索クエリです。Qiita teamでの検索条件をそのまま入れられます。  
ただし、空白を含む場合はダブルクオートで囲ってください  
例) "group:group1 test"  
検索条件を指定しない場合は、ダブルクオート2つ("")を設定してください。  

第３引数は1リクエストあたりの記事取得件数です。(デフォルトは5, 最大は100)

第４引数はリクエスト回数です。(デフォルトは1)  
Qiita APIには1時間あたりのリクエスト数に制限があるため、  
取得対象の記事数が多い場合は適切に区切ってください。  
https://qiita.com/api/v2/docs#利用制限

第５引数はページの取得開始位置です。(デフォルトは1)  
Qiita APIの利用制限によって一度でデータを取得しきれない場合は、  
こちらの引数を使用して前回の続きのページからデータ取得が可能です。

## Qiita APIの呼び出しに失敗しました。と表示された場合
エラー内容に"403 Forbidden"が含まれていた場合、  
Qiita APIの1時間あたりのリクエスト上限に達してしまった可能性があります。  

その場合は時間をあけて前回の続きからスクリプトを再実行してください。

エラーメッセージには何ページ目のデータ取得でエラーになったかが出力されているので、  
例えば `8ページ目のデータ取得でQiita APIの呼び出しに失敗しました。`と表示された場合は、  
第5引数を"8"に変更してスクリプトを再実行することで、前回の続きからデータの取得ができます。

## 画像のダウンロードに失敗しました。と表示された場合
画像のダウンロードはhttps通信を使用して記事内の画像のURLから直接ダウンロードを行っています。  
そのため、本スクリプトがアクセスできない場所にある画像ファイルはダウンロードできません。  
お手数ですがエラーメッセージ内の画像のパスを参考に手動でダウンロードを行ってください。

※Qiita Team上の画像は個人用アクセストークンを使用してダウンロードされます。


